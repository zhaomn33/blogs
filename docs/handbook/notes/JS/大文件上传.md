---
title: å¤§æ–‡ä»¶ä¸Šä¼ 
author: èµµä¸‰ä¸‰
date: '2023-10-31'
sidebar: auto
tags:
 - ä¸Šä¼ 
categories:
 - JS
---

::: tip
æœ¬æ–‡ä»¥ `react+ts+antd` ä¸ºä¾‹
:::
::: tip
å¤§è‡´æ€è·¯ï¼šåˆ©ç”¨`File`ç»§æ‰¿`Blob`çš„`slice`å±æ€§ï¼Œæ ¹æ®`size`å°†ä¸€ä¸ªå¤§æ–‡ä»¶åˆ‡å‰²æˆå°æ–‡ä»¶ï¼Œä¸€ç‰‡ä¸€ç‰‡çš„ä¸Šä¼ ï¼Œå½“å…¨éƒ¨ä¸Šä¼ å®Œæˆåï¼Œå†å°†æ‰€æœ‰åˆ‡ç‰‡åˆå¹¶æˆå¤§æ–‡ä»¶
:::

### ä¸€ã€å¤§æ–‡ä»¶åˆ‡ç‰‡

```
  import type { RcFile, UploadFile } from 'antd/es/upload/interface'
  /**
   * @description: æ–‡ä»¶åˆ‡ç‰‡
   * @param {UploadFile} file æ–‡ä»¶
   * @param {Number} LENGTH åˆ‡å‰²å¤§å°
   * @return {Array[Blob]}
  */
  const fileSlice = (file: UploadFile, LENGTH = 1024): Array<Blob> => {
    // console.log(file,'slice-file ğŸ”ª')
    const piece = LENGTH
    const totalSize = file.size ?? 0
    let start = 0 // æ¯æ¬¡ä¸Šä¼ çš„å¼€å§‹å­—èŠ‚
    let end = start + piece
    const chunks = [] // åˆ‡ç‰‡é›†åˆ

    while (start < totalSize) {
      // æ ¹æ®é•¿åº¦æˆªå–æ¯æ¬¡éœ€è¦ä¸Šä¼ çš„æ•°æ®
      const blob = file.slice(start, end)
      chunks.push(blob)
      start = end
      end = start + piece
    }
    return chunks
  }
```
- 1. Fileå¯¹è±¡ç»§æ‰¿è‡ªBlobå¯¹è±¡ï¼Œå› æ­¤åŒ…å«sliceæ–¹æ³•

### äºŒã€è·å–md5å€¼

```
  import SparkMD5 from 'spark-md5'
  // è·å–æ–‡ä»¶çš„md5
  const getMD5 = (file: RcFile) => {
    return new Promise(resolve => {
      const spark_md5 = new SparkMD5.ArrayBuffer()
      const fileReader = new FileReader()
      fileReader.onloadend = function(e) {
        spark_md5.append(e.target?.result as ArrayBuffer)
        const _md5 = spark_md5.end()
        resolve(_md5)
      }
      fileReader.readAsArrayBuffer(file)
    })
  }
```
- 1. ä½¿ç”¨ `spark-md5` è·å–md5å€¼
- 2. `fileReader` è¯»å–æ–‡ä»¶ï¼Œå¹¶å°†å…¶è½¬åŒ–ä¸º `ArrayBuffer`
- 3. `spark_md5.append()` æ·»åŠ æ–‡ä»¶çš„ArrayBuffer
- 4. `spark_md5.end()` è·å–å…¶md5å€¼
- 5. `readAsArrayBuffer` æœ€åè¯»å–æ–‡ä»¶
- 6. ä½¿ç”¨ `Promise`ï¼šæœ€åè¯»å–æ–‡ä»¶æ…¢ï¼Œä¾¿äºåœ¨è·å–åˆ°md5å€¼åå†è¿›è¡Œå…¶ä»–æ“ä½œ

### ä¸‰ã€æ­¥éª¤

- 1. antdçš„ä¸Šä¼ ç»„å»º Dragger
```
  <Dragger
    {...uploadProps}
    fileList={fileLists}
    className={styles['custom-upload-dragger-container']}
  >
    <p className="ant-upload-text !text-[14px]">
      <a className="text-[#2C72D7] hover:text-[#2C72D7] cursor-pointer">ç‚¹å‡»</a>
      æˆ–å°†æ–‡ä»¶æ‹–è‡³æ­¤å¤„ä¸Šä¼ 
    </p>
  </Dragger>
```
- 2. uploadPropsçš„å‚æ•°
  - ä¸Šä¼ ä¹‹å‰ - å¯¹äºä¸Šä¼ çš„æ–‡ä»¶çš„é™åˆ¶
  ```
    beforeUpload: async (fileData, fileList) => {
      console.log('ğŸ”¥ ä¸Šä¼ ä¹‹å‰', fileData, fileList)
      // æ–‡ä»¶å¤§å°è¶…è¿‡2GBï¼Œè¯·è”ç³»ç®¡ç†å‘˜åå°ä¸Šä¼ 
      // if (fileData.size! > maxFileSize) {
      //   !ignoredFiles.current.includes(fileData.uid) && ignoredFiles.current.push(fileData.uid)
      //   message.error(`${ fileData.name }æ–‡ä»¶å¤§å°è¶…è¿‡2GBï¼Œè¯·è”ç³»ç®¡ç†å‘˜åå°ä¸Šä¼ `)
      //   return Promise.reject(false)
      // }
      // è·å–æ•´ä½“æ–‡ä»¶çš„md5
      const _md5 = await getMD5(fileData as RcFile)
      // åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨
      if (md5List.current.includes(_md5 as string)) {
        // åœ¨å¿½ç•¥åˆ—è¡¨ä¸­æ·»åŠ å·²ç»å­˜åœ¨çš„æ–‡ä»¶id
        !ignoredFiles.current.includes(fileData.uid) &&
          ignoredFiles.current.push(fileData.uid)
        messageApi.error(`${ fileData.name }å·²ç»ä¸Šä¼ è¿‡ï¼Œè¯·å‹¿é‡å¤ä¸Šä¼ `)
        return Promise.reject(false)
      } else {
        md5List.current.push(_md5 as string)
      }
    }
  ```
  - å¼€å§‹ä¸Šä¼  - æ ¹æ®åˆ‡ç‰‡è¿›è¡Œä¸Šä¼  ï¼ˆæ­¤å¤„æ²¡æœ‰åšæ–­å¼€é‡ä¼ ï¼‰
  ```
    customRequest: async (info: UploadRequestOption) => {
      const upFile = info.file as RcFile
      const controller = new AbortController()
      setNextAbled(true) // æ­£åœ¨ä¸Šä¼ æ–‡ä»¶æ—¶ä¸èƒ½èµ°åˆ°ä¸‹ä¸€æ­¥

      // ä¸€ç‰‡ä¸€ç‰‡ä¸Šä¼ 
      for (let index = 0; index < file_uid_chunk.current[upFile.uid]?.length; index++) {
        const fileChunk = file_uid_chunk.current[upFile.uid][index]
        const formData = new FormData()
        formData.append('project_id', projectID)
        formData.append('file_id', file_uid_taskId.current[upFile.uid])
        formData.append('file', fileChunk)
        formData.append('number', index + '')

        // æ ¹æ®åç«¯ä¼ å›çš„åˆ‡ç‰‡çŠ¶æ€è¿›è¡Œæ“ä½œ
        const { error } = await getFilterResponse(
          await SharedApi.uploadChunks(formData)
        )
        if (error) {
          // å½“ä¸€ä¸ªæ–‡ä»¶çš„åˆ‡ç‰‡æœ‰ä¸€ç‰‡å¤±è´¥çš„æ—¶å€™å–æ¶ˆæ‰€æœ‰çš„è¯·æ±‚
          controller.abort()
          break
        } else {
          // è¿›åº¦æ¡
          let curPercent = Math.floor((100 / file_uid_chunk.current[upFile.uid].length) * (index + 1))
          // console.log(curPercent, 'cur ğŸ³', index)
          // ä¸Šä¼ æˆåŠŸå-ä¿®æ”¹è¿›åº¦æ¡çŠ¶æ€
          info.onProgress!({ percent: curPercent })
          if (file_uid_chunk.current[upFile.uid].length === index + 1) {
            curPercent = 100
            info.onSuccess!({})
          }
        }
      }
    }
  ```
  - æ‹–æ‹½ä¸Šä¼  - å¯ä»¥é™åˆ¶ä¸Šä¼ æ–‡ä»¶çš„ç±»å‹
  ```
    onDrop(e) {
      // æ‰€æœ‰æ‹–æ‹½ä¸Šä¼ çš„æ–‡ä»¶åç¼€æ•°ç»„
      const dropFileSuffixArr = Object.values(e.dataTransfer.files).map(item => item.name.split('.')[1])
      // æ˜¯å¦å…¨éƒ¨ä¸ºå¯ä¸Šä¼ çš„æ–‡ä»¶
      const isAllAcceptFile = dropFileSuffixArr.reduce((acc, suffix) => {
        return acc && (suffix==='csv'||suffix==='xlsx')
      }, true)
      if (!isAllAcceptFile) {
        messageApi.warning('ä»…æ”¯æŒä¸Šä¼ CSVæ–‡ä»¶å’ŒExcelæ–‡ä»¶')
      }
    }
  ```
  - ä¸Šä¼ åˆ—è¡¨æ”¹å˜ - ä¸Šä¼ å®Œæˆä¹‹å è¿›è¡Œåˆ‡ç‰‡åˆå¹¶ ä¿®æ”¹æ–‡ä»¶åˆ—è¡¨
  ```
    onChange: async (info) => {
      // console.log('ä¸Šä¼ åˆ—è¡¨æ”¹å˜ ğŸŒ¹', fileLists,'filelist', info.fileList)
      const { status } = info.file
      // console.log(status,'staus')
      // å¢åŠ åˆ¤æ–­é€»è¾‘-é˜²æ­¢åœ¨é˜»æ­¢ä¸Šä¼ åä»ç„¶æ”¹å˜fileListï¼Œå¯¼è‡´æ¸²æŸ“ä¸Šä¼ åˆ—è¡¨
      if (!status) {
        return
      } else {
        // æ–‡ä»¶åˆ—è¡¨æ”¹å˜å state fileList
        if (ignoredFiles.current.length > 0) {
          // è¿‡æ»¤å‡ºå·²ç»ä¸Šä¼ è¿‡çš„æ–‡ä»¶
          setFilelist([...info.fileList.filter(fileItem => !ignoredFiles.current.includes(fileItem.uid))])
          // è®¾ç½®å®Œæ–‡ä»¶åˆ—è¡¨å-ä»éœ€è¦å¿½ç•¥çš„åˆ—è¡¨ä¸­åˆ é™¤æ­¤æ–‡ä»¶uid
          const existedFile = info.fileList.findIndex(fileItem => ignoredFiles.current.includes(fileItem.uid))
          existedFile > -1 && ignoredFiles.current.splice(existedFile, 1)
          // ignoredFiles.current.includes(info.file.uid) &&
          //   (ignoredFiles.current = ignoredFiles.current.filter(item => item === info.file.uid))
        } else {
          setFilelist([...info.fileList])
        }
      }
      if (status === 'done' && info.file.percent === 100) {
        // åˆ‡ç‰‡åˆå¹¶
        const requestData = {
          project_id: projectID,
          file_id: file_uid_taskId.current[info.file.uid as string]
        }
        const { error } = await SharedApi.mergeChunks(requestData)
        if (!error) {
          messageApi.success(`${info.file.name}æ–‡ä»¶ä¸Šä¼ æˆåŠŸ`)
        } else {
          messageApi.error(`${info.file.name}æ–‡ä»¶åˆå¹¶å¤±è´¥`)
        }
      }
    }
  ```
