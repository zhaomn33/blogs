(window.webpackJsonp=window.webpackJsonp||[]).push([[52],{507:function(s,n,e){"use strict";e.r(n);var a=e(2),i=Object(a.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"title"}),n("p",[s._v("本文以 "),n("code",[s._v("react+ts+antd")]),s._v(" 为例")])]),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"title"}),n("p",[s._v("大致思路：利用"),n("code",[s._v("File")]),s._v("继承"),n("code",[s._v("Blob")]),s._v("的"),n("code",[s._v("slice")]),s._v("属性，根据"),n("code",[s._v("size")]),s._v("将一个大文件切割成小文件，一片一片的上传，当全部上传完成后，再将所有切片合并成大文件")])]),n("h3",{attrs:{id:"一、大文件切片"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一、大文件切片"}},[s._v("#")]),s._v(" 一、大文件切片")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("  import type { RcFile, UploadFile } from 'antd/es/upload/interface'\n  /**\n   * @description: 文件切片\n   * @param {UploadFile} file 文件\n   * @param {Number} LENGTH 切割大小\n   * @return {Array[Blob]}\n  */\n  const fileSlice = (file: UploadFile, LENGTH = 1024): Array<Blob> => {\n    // console.log(file,'slice-file 🔪')\n    const piece = LENGTH\n    const totalSize = file.size ?? 0\n    let start = 0 // 每次上传的开始字节\n    let end = start + piece\n    const chunks = [] // 切片集合\n\n    while (start < totalSize) {\n      // 根据长度截取每次需要上传的数据\n      const blob = file.slice(start, end)\n      chunks.push(blob)\n      start = end\n      end = start + piece\n    }\n    return chunks\n  }\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br")])]),n("ul",[n("li",[n("ol",[n("li",[s._v("File对象继承自Blob对象，因此包含slice方法")])])])]),s._v(" "),n("h3",{attrs:{id:"二、获取md5值"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#二、获取md5值"}},[s._v("#")]),s._v(" 二、获取md5值")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("  import SparkMD5 from 'spark-md5'\n  // 获取文件的md5\n  const getMD5 = (file: RcFile) => {\n    return new Promise(resolve => {\n      const spark_md5 = new SparkMD5.ArrayBuffer()\n      const fileReader = new FileReader()\n      fileReader.onloadend = function(e) {\n        spark_md5.append(e.target?.result as ArrayBuffer)\n        const _md5 = spark_md5.end()\n        resolve(_md5)\n      }\n      fileReader.readAsArrayBuffer(file)\n    })\n  }\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("ul",[n("li",[n("ol",[n("li",[s._v("使用 "),n("code",[s._v("spark-md5")]),s._v(" 获取md5值")])])]),s._v(" "),n("li",[n("ol",{attrs:{start:"2"}},[n("li",[n("code",[s._v("fileReader")]),s._v(" 读取文件，并将其转化为 "),n("code",[s._v("ArrayBuffer")])])])]),s._v(" "),n("li",[n("ol",{attrs:{start:"3"}},[n("li",[n("code",[s._v("spark_md5.append()")]),s._v(" 添加文件的ArrayBuffer")])])]),s._v(" "),n("li",[n("ol",{attrs:{start:"4"}},[n("li",[n("code",[s._v("spark_md5.end()")]),s._v(" 获取其md5值")])])]),s._v(" "),n("li",[n("ol",{attrs:{start:"5"}},[n("li",[n("code",[s._v("readAsArrayBuffer")]),s._v(" 最后读取文件")])])]),s._v(" "),n("li",[n("ol",{attrs:{start:"6"}},[n("li",[s._v("使用 "),n("code",[s._v("Promise")]),s._v("：最后读取文件慢，便于在获取到md5值后再进行其他操作")])])])]),s._v(" "),n("h3",{attrs:{id:"三、步骤"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#三、步骤"}},[s._v("#")]),s._v(" 三、步骤")]),s._v(" "),n("ul",[n("li",[n("ol",[n("li",[s._v("antd的上传组建 Dragger")])])])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('  <Dragger\n    {...uploadProps}\n    fileList={fileLists}\n    className={styles[\'custom-upload-dragger-container\']}\n  >\n    <p className="ant-upload-text !text-[14px]">\n      <a className="text-[#2C72D7] hover:text-[#2C72D7] cursor-pointer">点击</a>\n      或将文件拖至此处上传\n    </p>\n  </Dragger>\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("ul",[n("li",[n("ol",{attrs:{start:"2"}},[n("li",[s._v("uploadProps的参数")])]),s._v(" "),n("ul",[n("li",[s._v("上传之前 - 对于上传的文件的限制")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("  beforeUpload: async (fileData, fileList) => {\n    console.log('🔥 上传之前', fileData, fileList)\n    // 文件大小超过2GB，请联系管理员后台上传\n    // if (fileData.size! > maxFileSize) {\n    //   !ignoredFiles.current.includes(fileData.uid) && ignoredFiles.current.push(fileData.uid)\n    //   message.error(`${ fileData.name }文件大小超过2GB，请联系管理员后台上传`)\n    //   return Promise.reject(false)\n    // }\n    // 获取整体文件的md5\n    const _md5 = await getMD5(fileData as RcFile)\n    // 判断文件是否已存在\n    if (md5List.current.includes(_md5 as string)) {\n      // 在忽略列表中添加已经存在的文件id\n      !ignoredFiles.current.includes(fileData.uid) &&\n        ignoredFiles.current.push(fileData.uid)\n      messageApi.error(`${ fileData.name }已经上传过，请勿重复上传`)\n      return Promise.reject(false)\n    } else {\n      md5List.current.push(_md5 as string)\n    }\n  }\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br")])]),n("ul",[n("li",[s._v("开始上传 - 根据切片进行上传 （此处没有做断开重传）")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("  customRequest: async (info: UploadRequestOption) => {\n    const upFile = info.file as RcFile\n    const controller = new AbortController()\n    setNextAbled(true) // 正在上传文件时不能走到下一步\n\n    // 一片一片上传\n    for (let index = 0; index < file_uid_chunk.current[upFile.uid]?.length; index++) {\n      const fileChunk = file_uid_chunk.current[upFile.uid][index]\n      const formData = new FormData()\n      formData.append('project_id', projectID)\n      formData.append('file_id', file_uid_taskId.current[upFile.uid])\n      formData.append('file', fileChunk)\n      formData.append('number', index + '')\n\n      // 根据后端传回的切片状态进行操作\n      const { error } = await getFilterResponse(\n        await SharedApi.uploadChunks(formData)\n      )\n      if (error) {\n        // 当一个文件的切片有一片失败的时候取消所有的请求\n        controller.abort()\n        break\n      } else {\n        // 进度条\n        let curPercent = Math.floor((100 / file_uid_chunk.current[upFile.uid].length) * (index + 1))\n        // console.log(curPercent, 'cur 🍳', index)\n        // 上传成功后-修改进度条状态\n        info.onProgress!({ percent: curPercent })\n        if (file_uid_chunk.current[upFile.uid].length === index + 1) {\n          curPercent = 100\n          info.onSuccess!({})\n        }\n      }\n    }\n  }\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br")])]),n("ul",[n("li",[s._v("拖拽上传 - 可以限制上传文件的类型")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("  onDrop(e) {\n    // 所有拖拽上传的文件后缀数组\n    const dropFileSuffixArr = Object.values(e.dataTransfer.files).map(item => item.name.split('.')[1])\n    // 是否全部为可上传的文件\n    const isAllAcceptFile = dropFileSuffixArr.reduce((acc, suffix) => {\n      return acc && (suffix==='csv'||suffix==='xlsx')\n    }, true)\n    if (!isAllAcceptFile) {\n      messageApi.warning('仅支持上传CSV文件和Excel文件')\n    }\n  }\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("ul",[n("li",[s._v("上传列表改变 - 上传完成之后 进行切片合并 修改文件列表")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("  onChange: async (info) => {\n    // console.log('上传列表改变 🌹', fileLists,'filelist', info.fileList)\n    const { status } = info.file\n    // console.log(status,'staus')\n    // 增加判断逻辑-防止在阻止上传后仍然改变fileList，导致渲染上传列表\n    if (!status) {\n      return\n    } else {\n      // 文件列表改变后 state fileList\n      if (ignoredFiles.current.length > 0) {\n        // 过滤出已经上传过的文件\n        setFilelist([...info.fileList.filter(fileItem => !ignoredFiles.current.includes(fileItem.uid))])\n        // 设置完文件列表后-从需要忽略的列表中删除此文件uid\n        const existedFile = info.fileList.findIndex(fileItem => ignoredFiles.current.includes(fileItem.uid))\n        existedFile > -1 && ignoredFiles.current.splice(existedFile, 1)\n        // ignoredFiles.current.includes(info.file.uid) &&\n        //   (ignoredFiles.current = ignoredFiles.current.filter(item => item === info.file.uid))\n      } else {\n        setFilelist([...info.fileList])\n      }\n    }\n    if (status === 'done' && info.file.percent === 100) {\n      // 切片合并\n      const requestData = {\n        project_id: projectID,\n        file_id: file_uid_taskId.current[info.file.uid as string]\n      }\n      const { error } = await SharedApi.mergeChunks(requestData)\n      if (!error) {\n        messageApi.success(`${info.file.name}文件上传成功`)\n      } else {\n        messageApi.error(`${info.file.name}文件合并失败`)\n      }\n    }\n  }\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br")])])])])])}),[],!1,null,null,null);n.default=i.exports}}]);